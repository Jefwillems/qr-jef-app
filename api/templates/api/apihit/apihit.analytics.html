{% extends 'admin/base_site.html' %}
{% load i18n admin_urls static admin_list %}

{% if not is_popup %}
    {% block breadcrumbs %}
        <div class="breadcrumbs">
            <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
            &rsaquo; <a
                href="{% url 'admin:app_list' app_label=cl.opts.app_label %}">{{ cl.opts.app_config.verbose_name }}</a>
            &rsaquo; <a
                href="{% url 'admin:api_apihit_changelist' %}">{{ cl.opts.verbose_name_plural|capfirst }}</a>
            &rsaquo; Analytics
        </div>
    {% endblock %}
{% endif %}

{% block content %}
    <div class="chart-container" style="position:relative;width: 60vw;height: 60vh;margin:auto;">
        <canvas id="mchart"></canvas>
    </div>
    <script>

      const App = {
        init() {
          this.initState().then(
            () => this.drawChart('doughnut')
          );
        },
        initState() {
          this.state = {
            elements: {
              chart: null,
              ctx: document.getElementById('mchart')
            },
            data: [],
            labels: []
          };
          return fetch(`/api/apihits`).then(res => res.json()).then(hits => {
            this.state.data = hits;
            this.state.labels = [...new Set(hits.map(el => el.action))];
          })
        },
        drawChart(type) {
          if (this.state.elements.chart) {
            this.state.elements.chart.destroy()
          }
          this.state.elements.chart = new Chart(
            this.state.elements.ctx,
            {
              type,
              data: {
                labels: this.state.labels,
                datasets: [
                  {
                    label: '# of hits',
                    data: this.state.data.reduce((acc, curr) => {
                      const actionIndex = this.state.labels.findIndex(el => el === curr.action)
                      acc[actionIndex] += 1
                      return acc
                    }, [0, 0, 0]),
                    backgroundColor: [
                      'rgba(255, 99, 132, 0.2)',
                      'rgba(54, 162, 235, 0.2)',
                      'rgba(255, 206, 86, 0.2)',
                      'rgba(75, 192, 192, 0.2)',
                      'rgba(153, 102, 255, 0.2)',
                      'rgba(255,159,64,0.2)'
                    ],
                    borderColor: [
                      'rgba(255, 99, 132, 1)',
                      'rgba(54, 162, 235, 1)',
                      'rgba(255, 206, 86, 1)',
                      'rgba(75, 192, 192, 1)',
                      'rgba(153, 102, 255, 1)',
                      'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                  }
                ]
              },
              options: {
                scales: {},
                responsive: true,
                maintainAspectRatio: false,
                onClick: (ev, clickedOn) => {
                  if (clickedOn.length > 0) {
                    const id = clickedOn[0]._index;
                    const label = this.state.labels[id];
                    fetch(`/api/apihits/?search=${label}`).then(res => res.json()).then(hits => console.log(hits))
                  }
                }
              }
            }
          )
        }
      };

      App.init();
    </script>
{% endblock content %}
{% block extrahead %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"
            integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw=="
            crossorigin="anonymous"></script>
{% endblock %}
